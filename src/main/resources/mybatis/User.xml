<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shareku.mapper.auth.UserMapper">
	<sql id="userColumns">email,loginname,username,password,rights,status,role_id</sql>

	<resultMap type="User" id="userAndRoleResultMap">
		<id column="user_id" property="userId"/>
		<result column="loginname" property="loginname"/>
		<result column="username" property="username"/>
		<result column="password" property="password"/>
		<result column="user_rights" property="rights"/>
		<result column="status" property="status"/>
		<result column="last_login" property="lastLogin"/>
		
		<association property="role" column="role_id" javaType="Role">
			<id column="role_id" property="roleId"/>
			<result column="role_name" property="roleName"/>
			<result column="role_rights" property="rights"/>
		</association>
	</resultMap>
	<resultMap type="User" id="userResultMap">
		<id column="user_id" property="userId"/>
		<result column="loginname" property="loginname"/>
		<result column="username" property="username"/>
		<result column="password" property="password"/>
		<!-- BEGIN Ray -->
		<result column="email" property="email"/>
		<result column="gender" property="gender"/>
		<result column="birthday" property="birthday"/>
		<result column="qqcode" property="qqcode"/>
		<result column="occupation" property="occupation"/>
		<result column="phone" property="phone"/> 
		<result column="mobile" property="mobile"/> 
		<result column="address" property="address"/> 
		<result column="header_pic" property="header_pic"/> 
		<result column="user_desc" property="user_desc"/> 
		
		<!-- reset password -->
		<result column="encrypt_key" property="encrypt_key"/>
		<result column="timeout" property="timeout"/>
		<!-- END Ray -->
		<result column="rights" property="rights"/>
		<result column="status" property="status"/>
		<result column="role_id" property="roleId"/>
		
	</resultMap>
	
	<select id="listAllUser" resultMap="userAndRoleResultMap">
		select u.user_id,u.username,u.loginname,u.password,r.role_id,r.role_name ,u.last_login
		from shareku_user u 
		left join shareku_role r on u.role_id=r.role_id 
		where u.status=0 
	</select>
	
	<select id="listPageUser" parameterType="User" resultMap="userAndRoleResultMap">
		select u.user_id,u.username,u.loginname,u.password,r.role_id,r.role_name ,u.last_login
		from shareku_user u 
		left join shareku_role r on u.role_id=r.role_id 
		where u.status=0 
		<if test="loginname!=null and loginname!=''">
			and u.loginname like "%"#{loginname}"%" 
		</if>
		<if test="roleId!=null and roleId!=0">
			and u.role_id=#{roleId} 
		</if>
		<if test="lastLoginStart!=null">
		and u.last_login&gt;=#{lastLoginStart} 
		</if>
		<if test="lastLoginEnd!=null">
		and u.last_login&lt;=#{lastLoginEnd} 
		</if>
	</select>
	
	<select id="getUserInfo" parameterType="User" resultMap="userResultMap">
		select * from shareku_user where 1=1
		<if test="loginname!=null and password!=null">
		and loginname = #{loginname} and password=#{password}
		</if>
		<if test="userId!=null and userId>0">
		and user_id = #{userId}
		</if>
	</select>
	<select id="getUserById" parameterType="int" resultMap="userResultMap">
		select * from shareku_user u where u.user_id = #{userId}
	</select>
	<select id="getUserAndRoleById" parameterType="int" resultMap="userAndRoleResultMap">
		select u.user_id,u.username,u.rights as user_rights,u.loginname,u.password,r.role_id,r.role_name,r.rights as role_rights 
		from shareku_user u 
		left join shareku_role r on u.role_id=r.role_id 
		where u.status=0 and u.user_id=#{userId}
	</select>
	<select id="getCountByName" parameterType="User" resultType="int">
		select count(user_id) from shareku_user where loginname=#{loginname}
	</select>
	<select id="getCount" parameterType="User" resultType="int">
		select count(user_id) from shareku_user where status=0 
		<if test="loginname!=null and loginname!=''">
		 and loginname like "%"#{loginname}"%" 
		</if>
		<if test="roleId!=null and roleId!=0">
		and role_id=#{roleId} 
		</if>
		<if test="lastLoginStart!=null">
		and last_login&gt;=#{lastLoginStart} 
		</if>
		<if test="lastLoginEnd!=null">
		and last_login&lt;=#{lastLoginEnd} 
		</if>
	</select>
	
	<insert id="insertUser" parameterType="User" useGeneratedKeys="true" keyProperty="userId">
		insert shareku_user (<include refid="userColumns"/>) values (#{email},#{loginname},#{username},#{password},#{rights},0,#{roleId})
	</insert>
	<update id="updateUser" parameterType="User">
		update shareku_user set 
		loginname=#{loginname},
		username=#{username},password=#{password},
		rights=#{rights},
		status=#{status},
		role_id=#{roleId},
		last_login=#{lastLogin} 
		where user_id=#{userId}
	</update>
	<update id="updateLastLogin" parameterType="User">
		update shareku_user set last_login=#{lastLogin} where user_id=#{userId}
	</update>
	<update id="updateUserBaseInfo" parameterType="User">
		update shareku_user set 
		loginname=#{loginname},
		username=#{username},
		role_id=#{roleId}
		<if test="password!=null and password!=''">,password=#{password} </if>
		 where user_id=#{userId}
	</update>
	<update id="updateUserRights" parameterType="User">
		update shareku_user set rights=#{rights} where user_id=#{userId}
	</update>
	<delete id="deleteUser" parameterType="int">
		delete from shareku_user where user_id=#{userId}
	</delete>
	
<!-- BEGIN 前台个人中心、重置密码 -->
	<update id="updateUserBaseInfoByLoginname" parameterType="User">
		update shareku_user 
		<set>
			<if test="username != null">username=#{username},</if>
			<if test="password != null">password=#{password},</if>
			<if test="gender != null">gender=#{gender},</if>
			<if test="birthday != null">birthday=#{birthday},</if>
			<if test="qqcode != null">qqcode=#{qqcode},</if>
			<if test="occupation != null">occupation=#{occupation},</if>
			<if test="phone != null">phone=#{phone},</if>
			<if test="mobile != null">mobile=#{mobile},</if>
			<if test="address != null">address=#{address},</if>
			<if test="user_desc != null">user_desc=#{user_desc},</if>
			<if test="encrypt_key != null">encrypt_key=#{encrypt_key},</if>
			<if test="timeout != null">timeout=#{timeout}</if>
		</set>
		where loginname=#{loginname}
	</update>	
	
	<select id="findUserByLoginname" parameterType="String" resultType="User">
		select * from shareku_user where loginname=#{loginname}
	</select>
<!-- END 前台个人中心 -->
</mapper>